# Repotoire Auto-Fix GitLab CI Template
#
# Usage:
# 1. Include this template in your .gitlab-ci.yml:
#    include:
#      - local: '.gitlab/ci/auto-fix.yml'
#
# 2. Set required CI/CD variables in GitLab Settings > CI/CD > Variables:
#    - REPOTOIRE_NEO4J_PASSWORD: Neo4j password
#    - OPENAI_API_KEY: OpenAI API key
#    - GITLAB_ACCESS_TOKEN: GitLab personal access token with api scope
#
# 3. Configure schedule in GitLab CI/CD > Schedules for weekly runs

.auto-fix-base:
  image: python:3.11
  services:
    - name: neo4j:latest
      alias: neo4j
      variables:
        NEO4J_AUTH: neo4j/${REPOTOIRE_NEO4J_PASSWORD}
        NEO4J_PLUGINS: '["graph-data-science", "apoc"]'
  variables:
    REPOTOIRE_NEO4J_URI: bolt://neo4j:7687
    REPOTOIRE_NEO4J_USERNAME: neo4j
    MAX_FIXES: "50"
    DRY_RUN: "false"
  before_script:
    # Install system dependencies
    - apt-get update && apt-get install -y git curl jq

    # Install Node.js for jscpd
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs

    # Install Python dependencies
    - pip install --upgrade pip
    - pip install -e ".[dev,all-languages]"
    - pip install ruff pylint mypy bandit radon vulture
    - npm install -g jscpd

    # Install glab CLI
    - curl -s https://raw.githubusercontent.com/gitlab-org/cli/main/scripts/install.sh | sh
    - export PATH="/usr/local/bin:$PATH"

    # Configure git
    - git config --global user.email "repotoire-bot@example.com"
    - git config --global user.name "Repotoire Auto-Fix Bot"

    # Create Repotoire config
    - |
      cat > .repotoirerc.yml << EOF
      neo4j:
        uri: ${REPOTOIRE_NEO4J_URI}
        username: neo4j
        password: ${REPOTOIRE_NEO4J_PASSWORD}

      openai:
        api_key: ${OPENAI_API_KEY}

      auto_fix:
        max_fixes_per_run: ${MAX_FIXES}
        min_confidence: medium
        enabled_fix_types:
          - security
          - bug
          - style
          - type_hint
      EOF

repotoire:auto-fix:
  extends: .auto-fix-base
  stage: test
  rules:
    # Run on schedule
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # Run on manual trigger
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  script:
    # Wait for Neo4j to be ready
    - |
      echo "Waiting for Neo4j to start..."
      for i in {1..30}; do
        if curl -s http://neo4j:7474 > /dev/null; then
          echo "Neo4j is ready"
          break
        fi
        echo "Waiting for Neo4j... ($i/30)"
        sleep 2
      done

    # Ingest codebase
    - echo "Ingesting codebase..."
    - repotoire ingest . --generate-embeddings

    # Run auto-fix
    - echo "Running auto-fix..."
    - |
      DRY_RUN_FLAG=""
      if [ "$DRY_RUN" = "true" ]; then
        DRY_RUN_FLAG="--dry-run"
      fi

      repotoire auto-fix . \
        --max-fixes ${MAX_FIXES} \
        --auto-apply \
        --ci-mode \
        $DRY_RUN_FLAG \
        --output fixes.json || true

    # Check if fixes were applied
    - |
      if [ -f "fixes.json" ]; then
        FIX_COUNT=$(jq '.fixes | length' fixes.json)
        echo "Applied $FIX_COUNT fix(es)"
        echo "FIX_COUNT=$FIX_COUNT" >> ci_variables.env
      else
        echo "FIX_COUNT=0" >> ci_variables.env
      fi

    # Run tests if fixes were applied
    - |
      if [ -f "fixes.json" ] && [ "$FIX_COUNT" -gt 0 ]; then
        echo "Running tests to validate fixes..."
        if pytest --tb=short -q; then
          echo "TESTS_PASSED=true" >> ci_variables.env
        else
          echo "TESTS_PASSED=false" >> ci_variables.env
        fi
      fi

    # Create MR if not in dry-run mode
    - |
      if [ -f "fixes.json" ] && [ "$FIX_COUNT" -gt 0 ] && [ "$DRY_RUN" != "true" ]; then
        echo "Creating merge request..."

        # Create branch
        BRANCH_NAME="repotoire/auto-fix-${CI_PIPELINE_ID}"
        git checkout -b "$BRANCH_NAME"

        # Commit changes
        git add -A
        git commit -m "fix: apply automated code quality fixes

Applied $FIX_COUNT automated fixes.

ðŸ¤– Generated by Repotoire Auto-Fix"

        # Push branch
        git push -o merge_request.create \
                 -o merge_request.target=${CI_DEFAULT_BRANCH} \
                 -o merge_request.title="ðŸ¤– Auto-fix: Code quality improvements" \
                 -o merge_request.description="See MR description" \
                 -o merge_request.label="automated" \
                 -o merge_request.label="code-quality" \
                 -o merge_request.label="repotoire" \
                 origin "$BRANCH_NAME"

        # Update MR description with details
        MR_IID=$(glab mr list --source-branch="$BRANCH_NAME" --json iid --jq '.[0].iid')

        if [ -n "$MR_IID" ]; then
          glab mr update "$MR_IID" --description "$(cat <<EOF
## ðŸ¤– Auto-Fix Summary

Automated code quality fixes generated by Repotoire.

### Changes

Applied **$FIX_COUNT** fix(es) across the codebase.

See \`fixes.json\` artifact for detailed breakdown by fix type and confidence level.

### Testing

$(if [ "${TESTS_PASSED}" = "true" ]; then echo "- âœ… All tests passing"; else echo "- âš ï¸ Some tests failed - manual review recommended"; fi)

### Evidence

All fixes are backed by:
- ðŸŽ¯ Industry best practices
- ðŸ“š Code quality standards
- ðŸ” Similar patterns in codebase
- ðŸ¤– AI analysis with RAG context

---

ðŸ¤– Generated by **Repotoire Auto-Fix** on pipeline ${CI_PIPELINE_ID}

<!-- repotoire-auto-fix -->
EOF
)"

          # Mark as draft if tests failed
          if [ "${TESTS_PASSED}" != "true" ]; then
            glab mr update "$MR_IID" --draft
          fi
        fi
      fi

    # Report dry-run results
    - |
      if [ "$DRY_RUN" = "true" ] && [ "$FIX_COUNT" -gt 0 ]; then
        echo "âœ“ Dry-run mode: Found $FIX_COUNT potential fixes. No MR created."
      fi

  artifacts:
    paths:
      - fixes.json
    reports:
      dotenv: ci_variables.env
    expire_in: 30 days
    when: always

# Variant for manual runs with custom parameters
repotoire:auto-fix:custom:
  extends: .auto-fix-base
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  variables:
    # Override with custom values when triggering manually
    MAX_FIXES: "${MAX_FIXES_CUSTOM}"
    DRY_RUN: "${DRY_RUN_CUSTOM}"
  script:
    - !reference [repotoire:auto-fix, script]
  artifacts:
    paths:
      - fixes.json
    reports:
      dotenv: ci_variables.env
    expire_in: 30 days
    when: always
