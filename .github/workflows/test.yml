name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run unit tests
        run: uv run pytest tests/unit/ -v --tb=short

  differential:
    name: Differential Tests (Lean/Python)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run differential tests
        run: |
          uv run pytest tests/differential/ -v \
            --hypothesis-seed=${{ github.run_id }} \
            --hypothesis-profile=ci
        env:
          HYPOTHESIS_PROFILE: ci

  integration-neo4j:
    name: Integration Tests (Neo4j)
    runs-on: ubuntu-latest
    needs: [test]

    services:
      neo4j:
        image: neo4j:latest
        env:
          NEO4J_AUTH: neo4j/test-password
          NEO4J_PLUGINS: '["graph-data-science","apoc"]'
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p test-password 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run integration tests (excluding FalkorDB-specific)
        run: uv run pytest tests/integration/ -v --tb=short --ignore=tests/integration/test_falkordb.py
        env:
          REPOTOIRE_NEO4J_URI: bolt://localhost:7687
          REPOTOIRE_NEO4J_PASSWORD: test-password

  integration-falkordb:
    name: Integration Tests (FalkorDB)
    runs-on: ubuntu-latest
    needs: [test]

    services:
      falkordb:
        image: falkordb/falkordb:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Build Rust extension
        run: |
          cd repotoire-fast
          uv run maturin develop --release

      - name: Run FalkorDB integration tests
        run: uv run pytest tests/integration/test_falkordb.py -v --tb=short
        env:
          REPOTOIRE_NEO4J_URI: bolt://localhost:6379
          REPOTOIRE_NEO4J_PASSWORD: ""
