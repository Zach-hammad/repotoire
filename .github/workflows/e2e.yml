name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'repotoire/web/**'
      - 'repotoire/api/**'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches: [main]
    paths:
      - 'repotoire/web/**'
      - 'repotoire/api/**'
      - '.github/workflows/e2e.yml'

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  DATABASE_URL: postgresql://test:test@localhost:5433/repotoire_test
  TEST_DATABASE_URL: postgresql+asyncpg://test:test@localhost:5433/repotoire_test
  REDIS_URL: redis://localhost:6380/0
  REPOTOIRE_NEO4J_URI: bolt://localhost:6381
  REPOTOIRE_NEO4J_PASSWORD: ""
  REPOTOIRE_TEST_MODE: "true"

jobs:
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: repotoire_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      falkordb:
        image: falkordb/falkordb:latest
        ports:
          - 6381:6379
          - 7689:7687
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: repotoire/web/package-lock.json

      - name: Install Python dependencies
        run: uv sync --all-extras

      - name: Install Node dependencies
        run: npm ci
        working-directory: repotoire/web

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        working-directory: repotoire/web

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5433 -U test && break
            echo "Waiting for PostgreSQL... ($i)"
            sleep 1
          done

      - name: Run database migrations
        run: uv run alembic upgrade head

      - name: Create playwright auth directory
        run: mkdir -p repotoire/web/playwright/.auth

      - name: Start API server
        run: |
          uv run uvicorn repotoire.api.app:app --host 0.0.0.0 --port 8000 &
          sleep 5
          # Verify API is responding
          curl -f http://localhost:8000/health || exit 1
        env:
          CLERK_SECRET_KEY: "sk_test_fake"
          STRIPE_SECRET_KEY: "sk_test_fake"
          GITHUB_APP_ID: ""
          GITHUB_APP_PRIVATE_KEY: ""

      - name: Build Next.js app
        run: npm run build
        working-directory: repotoire/web
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: "pk_test_fake"
          NEXT_PUBLIC_API_URL: "http://localhost:8000"

      - name: Start Next.js server
        run: |
          npm run start &
          sleep 5
          # Verify app is responding
          curl -f http://localhost:3000 || exit 1
        working-directory: repotoire/web
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: "pk_test_fake"
          NEXT_PUBLIC_API_URL: "http://localhost:8000"

      - name: Run Playwright tests
        run: npx playwright test --project=chromium
        working-directory: repotoire/web
        env:
          TEST_BASE_URL: "http://localhost:3000"
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.sha }}
          path: repotoire/web/playwright-report/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results-${{ github.sha }}
          path: repotoire/web/test-results/
          retention-days: 7

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots-${{ github.sha }}
          path: repotoire/web/test-results/**/*.png
          retention-days: 7

  # Cross-browser tests on main branch only
  e2e-cross-browser:
    name: E2E Cross-Browser
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: repotoire_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379

      falkordb:
        image: falkordb/falkordb:latest
        ports:
          - 6381:6379

    strategy:
      fail-fast: false
      matrix:
        browser: [firefox, webkit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: repotoire/web/package-lock.json

      - name: Install Python dependencies
        run: uv sync --all-extras

      - name: Install Node dependencies
        run: npm ci
        working-directory: repotoire/web

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}
        working-directory: repotoire/web

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5433 -U test && break
            sleep 1
          done

      - name: Run database migrations
        run: uv run alembic upgrade head

      - name: Create playwright auth directory
        run: mkdir -p repotoire/web/playwright/.auth

      - name: Start API server
        run: |
          uv run uvicorn repotoire.api.app:app --host 0.0.0.0 --port 8000 &
          sleep 5
        env:
          CLERK_SECRET_KEY: "sk_test_fake"
          STRIPE_SECRET_KEY: "sk_test_fake"

      - name: Build and start Next.js
        run: |
          npm run build
          npm run start &
          sleep 5
        working-directory: repotoire/web
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: "pk_test_fake"
          NEXT_PUBLIC_API_URL: "http://localhost:8000"

      - name: Run Playwright tests (${{ matrix.browser }})
        run: npx playwright test --project=${{ matrix.browser }}
        working-directory: repotoire/web
        env:
          TEST_BASE_URL: "http://localhost:3000"
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}-${{ github.sha }}
          path: repotoire/web/playwright-report/
          retention-days: 7
