# Deploy Repotoire API and Workers to Fly.io
name: Deploy to Fly.io

on:
  push:
    branches: [main]
    paths:
      - 'repotoire/**'
      - 'Dockerfile'
      - 'fly.toml'
      - 'fly.worker.toml'
      - 'pyproject.toml'
      - 'uv.lock'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy API to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  deploy-worker:
    name: Deploy Workers
    runs-on: ubuntu-latest
    needs: deploy-api  # Deploy after API succeeds
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Workers to Fly.io
        run: flyctl deploy --remote-only --config fly.worker.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-worker]
    if: failure()
    steps:
      - name: Notify failure
        run: echo "Deployment failed! Check the logs."
        # Add Slack/Discord notification here if needed
