name: Repotoire Auto-Fix

on:
  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      max_fixes:
        description: 'Maximum number of fixes to apply'
        required: false
        default: '50'
      dry_run:
        description: 'Run in dry-run mode (no PR creation)'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest

    services:
      neo4j:
        image: neo4j:latest
        env:
          NEO4J_AUTH: neo4j/${{ secrets.NEO4J_PASSWORD }}
          NEO4J_PLUGINS: '["graph-data-science", "apoc"]'
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p $NEO4J_PASSWORD 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e ".[dev,all-languages]"

          # Install external tools for hybrid detectors
          pip install ruff pylint mypy bandit radon vulture
          npm install -g jscpd

      - name: Configure Repotoire
        run: |
          # Create config file
          cat > .repotoirerc.yml << EOF
          neo4j:
            uri: bolt://localhost:7687
            username: neo4j
            password: \${{ secrets.NEO4J_PASSWORD }}

          openai:
            api_key: \${{ secrets.OPENAI_API_KEY }}

          auto_fix:
            max_fixes_per_run: ${{ github.event.inputs.max_fixes || '50' }}
            min_confidence: medium
            enabled_fix_types:
              - security
              - bug
              - style
              - type_hint
          EOF

      - name: Ingest codebase
        run: |
          repotoire ingest . --generate-embeddings
        env:
          REPOTOIRE_NEO4J_URI: bolt://localhost:7687
          REPOTOIRE_NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Run auto-fix
        id: autofix
        run: |
          # Set dry-run flag
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          # Run auto-fix and capture output
          repotoire auto-fix . \
            --max-fixes ${{ github.event.inputs.max_fixes || '50' }} \
            --auto-apply \
            --ci-mode \
            $DRY_RUN_FLAG \
            --output fixes.json

          # Store fix count for later
          FIX_COUNT=$(jq '.fixes | length' fixes.json)
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT

          # Check if any fixes were applied
          if [ "$FIX_COUNT" -gt 0 ]; then
            echo "has_fixes=true" >> $GITHUB_OUTPUT
          else
            echo "has_fixes=false" >> $GITHUB_OUTPUT
          fi
        env:
          REPOTOIRE_NEO4J_URI: bolt://localhost:7687
          REPOTOIRE_NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Run tests
        if: steps.autofix.outputs.has_fixes == 'true'
        id: tests
        run: |
          # Run tests to validate fixes
          if pytest --tb=short -q; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Create Pull Request
        if: steps.autofix.outputs.has_fixes == 'true' && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            fix: apply automated code quality fixes

            Applied ${{ steps.autofix.outputs.fix_count }} automated fixes.

            ğŸ¤– Generated by Repotoire Auto-Fix
          branch: repotoire/auto-fix-${{ github.run_number }}
          delete-branch: true
          title: 'ğŸ¤– Auto-fix: Code quality improvements'
          body: |
            ## ğŸ¤– Auto-Fix Summary

            Automated code quality fixes generated by Repotoire.

            ### Changes

            Applied **${{ steps.autofix.outputs.fix_count }}** fix(es) across the codebase.

            See `fixes.json` for detailed breakdown by fix type and confidence level.

            ### Testing

            ${{ steps.tests.outputs.tests_passed == 'true' && '- âœ… All tests passing' || '- âš ï¸ Some tests failed - manual review recommended' }}

            ### Evidence

            All fixes are backed by:
            - ğŸ¯ Industry best practices
            - ğŸ“š Code quality standards
            - ğŸ” Similar patterns in codebase
            - ğŸ¤– AI analysis with RAG context

            ---

            ğŸ¤– Generated by **Repotoire Auto-Fix** on ${{ github.run_number }}

            <!-- repotoire-auto-fix -->
          labels: |
            automated
            code-quality
            repotoire
          draft: ${{ steps.tests.outputs.tests_passed != 'true' }}

      - name: Upload fix report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-fix-report
          path: |
            fixes.json
          retention-days: 30

      - name: Comment on dry-run
        if: github.event.inputs.dry_run == 'true' && steps.autofix.outputs.has_fixes == 'true'
        run: |
          echo "::notice::Dry-run mode: Found ${{ steps.autofix.outputs.fix_count }} potential fixes. No PR created."
