# Repotoire Code Analysis
# Add this workflow to your repository to enable automated code health checks on PRs
#
# Copy this file to .github/workflows/repotoire.yml in your repository

name: Code Health

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write
  security-events: write  # For SARIF upload

jobs:
  analyze:
    name: Repotoire Analysis
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate change detection
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Repotoire
        run: pip install repotoire
      
      - name: Run Analysis
        id: analyze
        run: |
          # For PRs, only analyze changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            repotoire ci --changed ${{ github.event.pull_request.base.sha }} \
              --sarif .repotoire/results.sarif \
              --fail-on high
          else
            repotoire ci \
              --sarif .repotoire/results.sarif \
              --fail-on critical
          fi
        continue-on-error: true
      
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: .repotoire/results.sarif
          category: repotoire
        continue-on-error: true
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read health summary
            let grade = 'N/A', score = 0;
            let findings = [];
            
            if (fs.existsSync('.repotoire/last_health.json')) {
              const health = JSON.parse(fs.readFileSync('.repotoire/last_health.json'));
              grade = health.grade || 'N/A';
              score = health.health_score || 0;
            }
            
            if (fs.existsSync('.repotoire/last_findings.json')) {
              const data = JSON.parse(fs.readFileSync('.repotoire/last_findings.json'));
              findings = data.findings || [];
            }
            
            // Count by severity
            const critical = findings.filter(f => f.severity === 'critical').length;
            const high = findings.filter(f => f.severity === 'high').length;
            const medium = findings.filter(f => f.severity === 'medium').length;
            const low = findings.filter(f => f.severity === 'low').length;
            const total = findings.length;
            
            // Status emoji
            const emoji = critical > 0 ? 'ğŸš¨' : high > 0 ? 'âš ï¸' : total > 0 ? 'ğŸ“‹' : 'âœ…';
            
            // Get previous counts from existing comment for trend
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body?.includes('Code Health:'));
            
            let prevCounts = null;
            if (existing) {
              // Parse previous counts from comment
              const match = existing.body.match(/ğŸ”´ Critical \| (\d+)/);
              const matchHigh = existing.body.match(/ğŸŸ  High \| (\d+)/);
              const matchMedium = existing.body.match(/ğŸŸ¡ Medium \| (\d+)/);
              const matchLow = existing.body.match(/ğŸŸ¢ Low \| (\d+)/);
              if (match) {
                prevCounts = {
                  critical: parseInt(match[1]) || 0,
                  high: parseInt(matchHigh?.[1]) || 0,
                  medium: parseInt(matchMedium?.[1]) || 0,
                  low: parseInt(matchLow?.[1]) || 0
                };
              }
            }
            
            // Trend indicator function
            const trend = (current, prev) => {
              if (prev === null || prev === undefined) return '';
              const diff = current - prev;
              if (diff > 0) return ` +${diff} â†‘`;
              if (diff < 0) return ` ${diff} â†“`;
              return ' â†’';
            };
            
            // Build file breakdown
            const fileIssues = {};
            for (const f of findings) {
              const file = f.file_path || f.path || 'unknown';
              fileIssues[file] = (fileIssues[file] || 0) + 1;
            }
            const sortedFiles = Object.entries(fileIssues)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 10);
            
            // Build link to file in PR
            const fileLink = (f) => {
              const file = f.file_path || f.path;
              const line = f.line_start || f.line || 1;
              if (!file) return '';
              // Link to the file in the PR's "Files changed" tab
              const base = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}/files`;
              const anchor = `#diff-${Buffer.from(file).toString('hex')}R${line}`;
              return `${base}${anchor}`;
            };
            
            // Sort findings by severity
            const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
            const sortedFindings = [...findings].sort((a, b) => 
              (severityOrder[a.severity] || 4) - (severityOrder[b.severity] || 4)
            );
            
            // Build top issues section (inline, not collapsed)
            let topIssues = '';
            if (sortedFindings.length > 0) {
              topIssues = '\n### Top Issues\n';
              const top5 = sortedFindings.slice(0, 5);
              for (let i = 0; i < top5.length; i++) {
                const f = top5[i];
                const sev = f.severity === 'critical' ? 'ğŸ”´' : 
                           f.severity === 'high' ? 'ğŸŸ ' : 
                           f.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                const file = f.file_path || f.path || 'N/A';
                const line = f.line_start || f.line || '';
                const title = f.title || f.message || f.rule_id || 'Issue';
                const loc = line ? `\`${file}:${line}\`` : `\`${file}\``;
                const link = fileLink(f);
                const linkPart = link ? ` - [View](${link})` : '';
                topIssues += `${i + 1}. ${sev} **${title}** in ${loc}${linkPart}\n`;
              }
            }
            
            // Build collapsible full findings
            let fullFindings = '';
            if (sortedFindings.length > 5) {
              fullFindings = `\n<details>\n<summary>ğŸ“‹ All findings (${sortedFindings.length})</summary>\n\n`;
              fullFindings += '| Severity | Issue | Location |\n';
              fullFindings += '|----------|-------|----------|\n';
              for (const f of sortedFindings) {
                const sev = f.severity === 'critical' ? 'ğŸ”´' : 
                           f.severity === 'high' ? 'ğŸŸ ' : 
                           f.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                const file = f.file_path || f.path || 'N/A';
                const line = f.line_start || f.line || '';
                const title = (f.title || f.message || f.rule_id || 'Issue').substring(0, 50);
                const loc = line ? `${file}:${line}` : file;
                const link = fileLink(f);
                const locCell = link ? `[\`${loc}\`](${link})` : `\`${loc}\``;
                fullFindings += `| ${sev} ${f.severity} | ${title} | ${locCell} |\n`;
              }
              fullFindings += '\n</details>';
            }
            
            // Build file breakdown section
            let fileBreakdown = '';
            if (sortedFiles.length > 0) {
              fileBreakdown = `\n<details>\n<summary>ğŸ“ Files with most issues (${sortedFiles.length})</summary>\n\n`;
              for (const [file, count] of sortedFiles) {
                fileBreakdown += `- \`${file}\` - ${count} issue${count > 1 ? 's' : ''}\n`;
              }
              fileBreakdown += '\n</details>';
            }
            
            const body = `## ${emoji} Code Health: ${grade} (${score}/100)

### Summary
| Severity | Count | Change |
|----------|-------|--------|
| ğŸ”´ Critical | ${critical} |${prevCounts ? trend(critical, prevCounts.critical) : ' -'} |
| ğŸŸ  High | ${high} |${prevCounts ? trend(high, prevCounts.high) : ' -'} |
| ğŸŸ¡ Medium | ${medium} |${prevCounts ? trend(medium, prevCounts.medium) : ' -'} |
| ğŸŸ¢ Low | ${low} |${prevCounts ? trend(low, prevCounts.low) : ' -'} |
${topIssues}${fullFindings}${fileBreakdown}

---
<sub>Powered by [Repotoire](https://repotoire.com)</sub>`;
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
      
      - name: Check result
        if: steps.analyze.outcome == 'failure'
        run: exit 1
